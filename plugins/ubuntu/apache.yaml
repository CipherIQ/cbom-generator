# Apache HTTPD SSL/TLS Scanner Plugin
# CBOM Generator v1.3 - Plugin Schema v1.0

plugin:
  plugin_schema_version: "1.0"
  name: "Apache HTTPD SSL/TLS Scanner"
  version: "1.0.0"
  author: "CipherIQ Team"
  category: "webserver"
  description: "Detects Apache HTTPD instances and extracts SSL/TLS configuration"
  priority: 50
  requires_cbom_version: "1.3.0"

detection:
  methods:
    # Method 1: Detect by binary executable (Phase 1: False Positive Elimination)
    - type: binary
      paths:
        - "/usr/sbin/apache2"
        - "/usr/sbin/httpd"
        - "/usr/local/apache2/bin/httpd"
      required: true
      confidence: 0.95

    # Method 2: Detect by process name
    - type: process
      names:
        - "apache2"
        - "httpd"
      command_patterns:
        - ".*httpd\\.conf.*"
        - ".*apache2\\.conf.*"

    # Method 3: Detect by listening port
    - type: port
      ports: [443, 8443]
      protocol: "tcp"
      check_ssl: true
      validate_process: true
      expected_processes:
        - "apache2"
        - "httpd"

    # Method 4: Detect by config file presence
    - type: config_file
      paths:
        - "/etc/apache2/apache2.conf"
        - "/etc/httpd/conf/httpd.conf"
        - "/usr/local/apache2/conf/httpd.conf"
      required: false

    # Method 5: Detect by systemd
    - type: systemd
      service_names:
        - "apache2.service"
        - "httpd.service"

    # Method 6: Detect by package (Phase 2: Server/Exclude Validation)
    - type: package
      package_names:
        - "apache2"
        - "httpd"
        - "apache2-utils"
      server_packages:
        - "apache2"
        - "httpd"
      exclude_packages:
        - "apache2-utils"
        - "apache2-doc"
        - "apache2-dev"
      confidence: 0.90

config_extraction:
  files:
    # Production Apache SSL/TLS config paths
    - path: "/etc/apache2/sites-enabled/default-ssl.conf"
      parser: "apache"
      encoding: "utf-8"
      crypto_directives:
        # SSL Engine
        - key: "SSLEngine"
          type: "boolean"
          maps_to: "service.tls_enabled"
          optional: false

        # Certificate file
        - key: "SSLCertificateFile"
          type: "path"
          resolve: true
          maps_to: "certificate.path"
          optional: true

        # Private key file
        - key: "SSLCertificateKeyFile"
          type: "path"
          resolve: true
          maps_to: "private_key.path"
          optional: true

        # CA certificate file
        - key: "SSLCACertificateFile"
          type: "path"
          resolve: true
          maps_to: "ca_certificate.path"
          optional: true

        # Protocol configuration
        - key: "SSLProtocol"
          type: "string"
          maps_to: "protocol.min_version"
          optional: true

        # Cipher suite configuration
        - key: "SSLCipherSuite"
          type: "string"
          maps_to: "cipher_suites"
          optional: true

        # Honor cipher order
        - key: "SSLHonorCipherOrder"
          type: "boolean"
          default: "off"
          maps_to: "protocol.server_cipher_preference"
          optional: true

        # OCSP stapling
        - key: "SSLUseStapling"
          type: "boolean"
          default: "off"
          maps_to: "service.ocsp_stapling"
          optional: true
