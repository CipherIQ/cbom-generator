# MySQL/MariaDB SSL/TLS Scanner Plugin
# CBOM Generator v1.3 - Plugin Schema v1.0

plugin:
  plugin_schema_version: "1.0"
  name: "MySQL SSL/TLS Scanner"
  version: "1.0.0"
  author: "CipherIQ Team"
  category: "database"
  description: "Detects MySQL/MariaDB instances and extracts SSL/TLS configuration"
  priority: 50
  requires_cbom_version: "1.3.0"

detection:
  methods:
    # Method 1: Detect by binary executable (Phase 1: False Positive Elimination)
    - type: binary
      paths:
        - "/usr/sbin/mysqld"
        - "/usr/sbin/mariadbd"
        - "/usr/bin/mysqld"
        - "/usr/local/mysql/bin/mysqld"
      required: true
      confidence: 0.95

    # Method 2: Detect by process name
    - type: process
      names:
        - "mysqld"
        - "mariadbd"

    # Method 3: Detect by listening port
    - type: port
      ports: [3306, 3307]
      protocol: "tcp"
      check_ssl: true
      validate_process: true
      expected_processes:
        - "mysqld"
        - "mariadbd"

    # Method 4: Detect by config file
    - type: config_file
      paths:
        - "/etc/mysql/my.cnf"
        - "/etc/my.cnf"
        - "/etc/mysql/mysql.conf.d/mysqld.cnf"
        - "/usr/local/mysql/my.cnf"
      required: false

    # Method 5: Detect by package (Phase 2: Server/Exclude Validation)
    - type: package
      package_names:
        - "mysql-server"
        - "mysql-server-8.0"
        - "mysql-server-5.7"
        - "mysql-common"
      server_packages:
        - "mysql-server"
        - "mysql-server-8.0"
        - "mysql-server-5.7"
      exclude_packages:
        - "mysql-common"
        - "mysql-client"
        - "libmysqlclient21"
      confidence: 0.90

config_extraction:
  files:
    - path: "/etc/mysql/my.cnf"
      parser: "ini"
      encoding: "utf-8"
      crypto_directives:
        # SSL enablement
        - key: "ssl"
          type: "boolean"
          default: "false"
          maps_to: "service.tls_enabled"
          optional: true

        # CA certificate
        - key: "ssl-ca"
          type: "path"
          resolve: true
          maps_to: "ca_certificate.path"
          optional: true

        # Server certificate
        - key: "ssl-cert"
          type: "path"
          resolve: true
          maps_to: "certificate.path"
          optional: true

        # Server private key
        - key: "ssl-key"
          type: "path"
          resolve: true
          maps_to: "private_key.path"
          optional: true

        # Cipher list
        - key: "ssl-cipher"
          type: "string_list"
          separator: ":"
          maps_to: "cipher_suites"
          optional: true

        # Require SSL for connections
        - key: "require-secure-transport"
          type: "boolean"
          default: "false"
          maps_to: "service.require_tls"
          optional: true

        # TLS version (MariaDB)
        - key: "tls_version"
          type: "string_list"
          separator: ","
          maps_to: "protocol.tls_versions"
          optional: true
