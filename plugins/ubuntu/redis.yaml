# Redis TLS Scanner Plugin
# CBOM Generator v1.3 - Plugin Schema v1.0

plugin:
  plugin_schema_version: "1.0"
  name: "Redis TLS Scanner"
  version: "1.0.0"
  author: "CipherIQ Team"
  category: "cache"
  description: "Detects Redis instances and extracts TLS configuration"
  priority: 50
  requires_cbom_version: "1.3.0"

detection:
  methods:
    # Method 1: Detect by binary executable (Phase 1: False Positive Elimination)
    - type: binary
      paths:
        - "/usr/bin/redis-server"
        - "/usr/local/bin/redis-server"
        - "/opt/redis/bin/redis-server"
      required: true
      confidence: 0.95

    # Method 2: Detect by process name
    - type: process
      names:
        - "redis-server"

    # Method 3: Detect by listening port
    - type: port
      ports: [6379, 6380]
      protocol: "tcp"
      check_ssl: true
      validate_process: true
      expected_processes:
        - "redis-server"

    # Method 4: Detect by config file
    - type: config_file
      paths:
        - "/etc/redis/redis.conf"
        - "/etc/redis.conf"
        - "/usr/local/etc/redis.conf"
      required: false

config_extraction:
  files:
    - path: "/etc/redis/redis.conf"
      parser: "ini"
      encoding: "utf-8"
      crypto_directives:
        # TLS port
        - key: "tls-port"
          type: "integer"
          default: "0"
          maps_to: "service.tls_port"
          optional: true

        # TLS certificate file
        - key: "tls-cert-file"
          type: "path"
          resolve: true
          maps_to: "certificate.path"
          optional: true

        # TLS private key file
        - key: "tls-key-file"
          type: "path"
          resolve: true
          maps_to: "private_key.path"
          optional: true

        # TLS CA certificate file
        - key: "tls-ca-cert-file"
          type: "path"
          resolve: true
          maps_to: "ca_certificate.path"
          optional: true

        # TLS CA certificate directory
        - key: "tls-ca-cert-dir"
          type: "path"
          resolve: true
          maps_to: "ca_certificate.directory"
          optional: true

        # TLS protocols
        - key: "tls-protocols"
          type: "string_list"
          separator: " "
          maps_to: "protocol.tls_versions"
          optional: true

        # TLS ciphers
        - key: "tls-ciphers"
          type: "string_list"
          separator: ":"
          maps_to: "cipher_suites"
          optional: true

        # TLS cipher suites (TLS 1.3)
        - key: "tls-ciphersuites"
          type: "string_list"
          separator: ":"
          maps_to: "cipher_suites"
          optional: true

        # Prefer server ciphers
        - key: "tls-prefer-server-ciphers"
          type: "boolean"
          default: "false"
          maps_to: "protocol.server_cipher_preference"
          optional: true

        # Require TLS for replication
        - key: "tls-replication"
          type: "boolean"
          default: "false"
          maps_to: "service.tls_replication"
          optional: true

        # Require TLS for cluster
        - key: "tls-cluster"
          type: "boolean"
          default: "false"
          maps_to: "service.tls_cluster"
          optional: true

        # Authenticate clients
        - key: "tls-auth-clients"
          type: "string"
          enum: ["yes", "no", "optional"]
          default: "yes"
          maps_to: "service.client_auth_mode"
          optional: true
